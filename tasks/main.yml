---

# ----- set drbd device -----

- name: parted drbd disk
  parted:
    device: "{{ ha_drbd_disk }}"
    number: 1
    state: present

- name: Create drbd-vg1
  lvg:
    vg: drbdpool
    pvs: "{{ ha_drbd_disk }}1"

# ----- set drbd9 -----

- name: import RPM-GPG-KEY-elrepo
  rpm_key:
    state: present
    key: https://www.elrepo.org/RPM-GPG-KEY-elrepo.org
  tags: drbd9

- name: install elrepo repository
  yum:
    name: http://www.elrepo.org/elrepo-release-7.0-3.el7.elrepo.noarch.rpm
  tags: drbd9

- name: install drbd9
  yum:
    name:
      - kmod-drbd90
      - drbd90-utils
    state: present
  tags: drbd9

- name: deploy drbd1.res
  template:
    src: "drbd1.res.j2"
    dest: "/etc/drbd.d/drbd1.res"
    owner: "root"
    group: "root"
    mode: 0644    

- name: deploy global_common.conf
  copy:
    src: "global_common.conf"
    dest: "/etc/drbd.d/global_common.conf"
    owner: "root"
    group: "root"
    mode: 0644

- name: make drbd mount directory 
  file:
    path: "{{ ha_drbd_mount_dir }}"
    owner: root
    group: root
    mode: 0755
    state: directory

- name: create drbd meta r1
  command: "/usr/sbin/drbdadm create-md r1 --force"
  when: ha_drbd_initialize == true

- name: drbdadm up r1
  command: "/usr/sbin/drbdadm up r1"
  when: ha_drbd_initialize == true

- name: drbdadm new-current-uuid --clear-bitmap r1
  command: "/usr/sbin/drbdadm new-current-uuid --clear-bitmap r1"
  when:
    - ha_drbd_initialize == true
    - ha_drbd_role == "primary"

- name: mkfs.xfs -f /dev/drbd1
  command: "/usr/sbin/mkfs.xfs -f /dev/drbd1"
  when: 
    - ha_drbd_initialize == true
    - ha_drbd_role == "primary"

# ----- set keepalived -----

- name: install keepalived
  yum:
    name: keepalived
    state: present
  tags: keepalived

- name: config keepalived.conf
  template:
    src: "keepalived.conf.j2"
    dest: "/etc/keepalived/keepalived.conf"
    owner: "root"
    group: "root"
    mode: 0644

- name: deploy keepalived_script
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: "root"
    group: "root"
    mode: 0755
  with_items:
    - { src: 'keepalived_script/check_drbd.sh.j2',dest: '/usr/local/bin/check_drbd.sh' }
    - { src: 'keepalived_script/ctrl_drbd.sh.j2',dest: '/usr/local/bin/ctrl_drbd.sh' }
    - { src: 'keepalived_script/save_drbd_status.sh.j2',dest: '/usr/local/bin/save_drbd_status.sh' }
